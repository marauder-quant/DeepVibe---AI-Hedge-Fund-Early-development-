# Trading Bot

This directory contains the SMA (Simple Moving Average) trading bot that interacts with the Alpaca API.

## Functionality

The bot performs the following actions:

1.  **Reads Market Context**: Fetches the current economic quadrant and analysis notes from the `market_analysis.db` database (generated by the scripts in the `market_analysis/` directory).
2.  **Selects Stocks**: Chooses a list of stocks to trade based on the current quadrant and stock grades defined in `config.py` (`QUADRANT_STOCK_GRADES` and `GRADE_LIMIT_MAP`). It retrieves the relevant stock lists from the database.
3.  **Determines Allocation**: Calculates the target equity allocation percentage based on the current quadrant as defined in `config.py` (`QUADRANT_ALLOCATIONS`).
4.  **Applies SMA Strategy**: For each selected stock, it monitors the price relative to a Simple Moving Average (SMA) on a specific timeframe (both configured in `config.py`).
    *   **Entry Signal**: If the price closes above the SMA and the bot does not have a position, it calculates a buy quantity (based on target allocation and portfolio value) and places a buy order.
    *   **Exit Signal**: If the price closes below the SMA and the bot holds a position, it places a sell order to close the entire position.
5.  **Continuous Monitoring**: The bot runs in a loop, calculating the time until the next market data bar closes (plus a buffer) and re-evaluating the strategy signals after the wait.

## Available Bots

* **`sma_bot_21_4h.py`**: The original SMA bot that uses market orders during regular trading hours.
* **`sma_bot_21_4h_after_hours.py`**: Enhanced version that supports after-hours trading using limit orders with configurable slippage tolerance, providing 24/7 trading capability.

## Configuration (`config.py`)

This file allows you to customize the bot's behavior without modifying the main script. Key settings include:

*   `SMA_PERIOD`: The lookback period for the Simple Moving Average.
*   `TIMEFRAME`: The data interval used for the SMA calculation and signal generation (e.g., "1h", "4h", "1d" - must be valid for Yahoo Finance).
*   `AFTER_HOURS_SLIPPAGE_TOLERANCE`: Percentage adjustment applied to limit orders during after-hours trading.
*   `TOP_A_PLUS_STOCKS`, `TOP_A_STOCKS`, `TOP_B_STOCKS`, etc.: The maximum number of stocks to retrieve for each grade.
*   `TRADE_SIZE_PERCENT_OF_EQUITY_ALLOCATION`: Controls position sizing as a percentage of the quadrant's equity allocation.
*   `QUADRANT_ALLOCATIONS`: A dictionary mapping each economic quadrant label to a target equity allocation percentage (0.0 to 1.0). Supported quadrants include:
    * `A` (Inflation fighting): Conservative allocation (20%)
    * `B` (Growth with inflation): Balanced with growth bias (50%)
    * `C` (Transition to growth): Balanced with value bias (70%)
    * `D` (Growth quadrant): Aggressive allocation (100%)
    * `Unknown`: Default conservative allocation (20%)
*   `QUADRANT_STOCK_GRADES`: A dictionary mapping each quadrant label to a list of acceptable stock grades. The order determines priority.
*   `GRADE_LIMIT_MAP`: Maps the grade strings to the corresponding `TOP_*_STOCKS` variable.
*   `DEFAULT_QUADRANT`: The quadrant assumed if data is missing from the database.

## Usage

*(Ensure you have completed the setup steps in the main project [README.md](../../README.md))*.

Commands should typically be run from the project's root directory (`/workspaces/dmac_strategy_research_alpaca/`).

1.  **Configure the Bot**: Edit `trading_bot/config.py` to set your desired strategy parameters, stock selection rules, and allocations.

2.  **Run the Trading Bot**: Start the bot for live or paper trading.
    ```bash
    # Regular trading hours version
    python trading_bot/sma_bot_21_4h.py
    
    # 24/7 trading with after-hours support
    python trading_bot/sma_bot_21_4h_after_hours.py
    ```
    The bot will print its status, selected stocks, allocation, and then monitor signals continuously. Press `Ctrl+C` to stop it.

3.  **Check Positions & Orders**: Use this script to quickly view your current Alpaca account status, open positions, and pending orders.
    ```bash
    python trading_bot/check_positions.py
    ```

4.  **Emergency Kill Switch**: Use this script to immediately cancel all open orders and liquidate (sell) all existing positions in your Alpaca account. **Use with caution!**
    ```bash
    # With confirmation prompt (Recommended)
    python trading_bot/kill_switch.py

    # Without confirmation prompt (Force close)
    python trading_bot/kill_switch.py --force
    ```
    *You can add `--live` to either command to target your live account instead of the default paper account.*

## Important Notes

*   **Strategy Simplicity**: The current bot uses a basic SMA crossover strategy. It does **not** utilize the optimized parameters potentially generated by the `backtests/` module.
*   **Error Handling**: Basic error handling is included, but robust production systems require more sophisticated monitoring and alerting.
*   **Market Data**: Relies on Yahoo Finance (`yfinance`) for market data, which may have limitations or delays.
*   **Dependencies**: Ensure the correct database (`market_analysis/data/market_analysis.db`) exists and is populated by the `market_analysis` scripts.
*   **After-Hours Trading**: When using the after-hours version, be aware that liquidity may be limited and slippage could be higher than during regular hours. 